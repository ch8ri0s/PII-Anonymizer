<story-context id="bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>6</epicId>
    <storyId>2</storyId>
    <title>ReDoS Vulnerability Fix</title>
    <status>drafted</status>
    <generatedAt>2025-12-14</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/stories/6-2-redos-vulnerability-fix.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>security engineer</asA>
    <iWant>the fuzzy regex matching to be protected against ReDoS attacks</iWant>
    <soThat>malicious input cannot cause CPU exhaustion or application hangs</soThat>
    <tasks>
      <task id="1" name="Analyze Current Vulnerability" acs="1,3">
        <subtask id="1.1">Profile buildFuzzyRegex with attack patterns</subtask>
        <subtask id="1.2">Document vulnerable pattern: ${char}[^a-zA-Z0-9]{0,3}</subtask>
        <subtask id="1.3">Identify all regex patterns in codebase for similar issues</subtask>
      </task>
      <task id="2" name="Implement Timeout Wrapper" acs="1">
        <subtask id="2.1">Create src/utils/safeRegex.ts with timeout support</subtask>
        <subtask id="2.2">Use vm.runInNewContext or worker thread for isolation</subtask>
        <subtask id="2.3">Add fallback behavior when timeout occurs</subtask>
      </task>
      <task id="3" name="Redesign Fuzzy Matching" acs="3">
        <subtask id="3.1">Replace unbounded quantifiers with bounded alternatives</subtask>
        <subtask id="3.2">Consider using linear-time fuzzy matching library (fuse.js)</subtask>
        <subtask id="3.3">Benchmark new implementation vs old</subtask>
      </task>
      <task id="4" name="Add Input Validation" acs="2">
        <subtask id="4.1">Add length check before regex processing</subtask>
        <subtask id="4.2">Implement chunking for large inputs</subtask>
        <subtask id="4.3">Log oversized inputs for monitoring</subtask>
      </task>
      <task id="5" name="Security Testing" acs="4">
        <subtask id="5.1">Create ReDoS attack test vectors</subtask>
        <subtask id="5.2">Add performance regression tests</subtask>
        <subtask id="5.3">Document security considerations in SECURITY.md</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1" title="Timeout Protection">
      <requirement>Regex execution completes within 100ms per pattern</requirement>
      <requirement>Timeout violations are logged and processing continues with fallback</requirement>
      <requirement>No application hangs regardless of input</requirement>
    </criterion>
    <criterion id="AC2" title="Input Length Limits">
      <requirement>Input strings are length-limited before regex processing</requirement>
      <requirement>Maximum segment size: 10,000 characters</requirement>
      <requirement>Longer inputs are split and processed in chunks</requirement>
    </criterion>
    <criterion id="AC3" title="Pattern Redesign">
      <requirement>Nested quantifiers are replaced with atomic alternatives</requirement>
      <requirement>Catastrophic backtracking is prevented through pattern redesign</requirement>
      <requirement>Pattern efficiency is validated with benchmark tests</requirement>
    </criterion>
    <criterion id="AC4" title="Security Test Suite">
      <requirement>ReDoS test cases added to security test suite</requirement>
      <requirement>Exponential backtracking patterns are tested</requirement>
      <requirement>Performance regression tests prevent reintroduction</requirement>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/CODE_REVIEW.md</path>
        <title>Comprehensive Code Review</title>
        <section>Critical Issues - Issue #2</section>
        <snippet>Regex ReDoS Vulnerability in buildFuzzyRegex at fileProcessor.js:114-134. Nested quantifiers create exponential backtracking. Attacker can craft input causing CPU exhaustion (DoS).</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Story 6.2: ReDoS Vulnerability Fix</section>
        <snippet>Critical security fix - Pattern `${char}[^a-zA-Z0-9]{0,3}` creates exponential backtracking. Fix options include timeout wrapper, pattern redesign, or linear-time library.</snippet>
      </doc>
      <doc>
        <path>docs/archive/PERFORMANCE_ANALYSIS.md</path>
        <title>Performance Analysis</title>
        <section>ReDoS Vulnerability</section>
        <snippet>Documents the buildFuzzyRegex vulnerability with exploit examples showing how pattern like "International Business Machines Corporation" can cause hangs.</snippet>
      </doc>
      <doc>
        <path>docs/archive/SECURITY_AUDIT.md</path>
        <title>Security Audit</title>
        <section>ReDoS Testing</section>
        <snippet>Includes test vector buildFuzzyRegex('a'.repeat(10000)) for validating ReDoS protection.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>fileProcessor.js</path>
        <kind>core-processing</kind>
        <symbol>buildFuzzyRegex</symbol>
        <lines>341-394</lines>
        <reason>PRIMARY TARGET: Current implementation has protection layers (length limits, non-greedy quantifiers) but original CODE_REVIEW.md issue still references vulnerable pattern structure</reason>
      </artifact>
      <artifact>
        <path>fileProcessor.js</path>
        <kind>usage</kind>
        <symbol>buildFuzzyRegex call</symbol>
        <lines>633-638</lines>
        <reason>Where buildFuzzyRegex is invoked during anonymization - needs to handle null returns gracefully</reason>
      </artifact>
      <artifact>
        <path>src/core/anonymization.ts</path>
        <kind>typescript-implementation</kind>
        <symbol>buildFuzzyRegex</symbol>
        <lines>26-68</lines>
        <reason>TypeScript version with same protection layers - must stay in sync with JS version</reason>
      </artifact>
      <artifact>
        <path>src/core/index.ts</path>
        <kind>exports</kind>
        <symbol>buildFuzzyRegex export</symbol>
        <lines>15</lines>
        <reason>Export location for TypeScript buildFuzzyRegex</reason>
      </artifact>
      <artifact>
        <path>src/utils/LoggerFactory.ts</path>
        <kind>utility</kind>
        <symbol>LoggerFactory</symbol>
        <lines>244-351</lines>
        <reason>From Story 6.1 - use LoggerFactory.create('safeRegex') for logging in new safe regex module</reason>
      </artifact>
      <artifact>
        <path>test/unit/buildFuzzyRegex.test.js</path>
        <kind>test</kind>
        <symbol>buildFuzzyRegex Direct ReDoS Test</symbol>
        <lines>1-177</lines>
        <reason>Existing ReDoS tests demonstrating vulnerability patterns - enhance with new test vectors</reason>
      </artifact>
      <artifact>
        <path>test/unit/fileProcessor.redos.test.js</path>
        <kind>test</kind>
        <symbol>FileProcessor ReDoS Protection</symbol>
        <lines>1-265</lines>
        <reason>Integration tests for ReDoS protection through FileProcessor - add timeout and fallback tests</reason>
      </artifact>
    </code>
    <dependencies>
      <node>
        <package>@xenova/transformers</package>
        <version>2.17.2</version>
        <relevance>ML model inference - unrelated to regex</relevance>
      </node>
      <potential-additions>
        <package>fuse.js</package>
        <reason>Linear-time fuzzy matching alternative to regex - consider for Task 3.2</reason>
      </potential-additions>
      <potential-additions>
        <package>fastest-levenshtein</package>
        <reason>Alternative linear-time string matching library</reason>
      </potential-additions>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint source="CODE_REVIEW.md">Pattern `${char}[^a-zA-Z0-9]{0,3}` with unbounded quantifiers causes exponential O(2^n) backtracking</constraint>
    <constraint source="fileProcessor.js">Current protections: MAX_ENTITY_LENGTH=50, MIN_ENTITY_LENGTH=3, char count limit=30, non-greedy {0,2}?</constraint>
    <constraint source="JavaScript">No native support for possessive quantifiers or atomic groups - must use alternative patterns</constraint>
    <constraint source="Electron">vm.runInNewContext has limitations in renderer process - may need worker threads</constraint>
    <constraint source="Performance">Regex execution must complete within 100ms per pattern per AC1</constraint>
    <constraint source="Backward Compatibility">Must maintain fuzzy matching capability for legitimate entity text variations</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>buildFuzzyRegex</name>
      <kind>function</kind>
      <signature>function buildFuzzyRegex(mergedString: string): RegExp | null</signature>
      <path>fileProcessor.js:341, src/core/anonymization.ts:26</path>
    </interface>
    <interface>
      <name>LoggerFactory.create</name>
      <kind>static-method</kind>
      <signature>static create(scope: string): Logger</signature>
      <path>src/utils/LoggerFactory.ts:332</path>
    </interface>
    <interface>
      <name>FileProcessor.processFile</name>
      <kind>static-method</kind>
      <signature>static async processFile(filePath: string, outputPath: string): Promise&lt;ProcessResult&gt;</signature>
      <path>fileProcessor.js</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Testing uses Mocha + Chai framework with 10-second default timeout. Security tests should use shorter timeouts (2-5 seconds) to detect exponential backtracking. Test files go in test/unit/ with .test.js extension. Console output capture pattern from LoggerFactory.test.js can be adapted for timing measurements.
    </standards>
    <locations>
      <location>test/unit/buildFuzzyRegex.test.js</location>
      <location>test/unit/fileProcessor.redos.test.js</location>
      <location>test/unit/</location>
    </locations>
    <ideas>
      <idea ac="AC1">Test regex timeout: Create attack string 'a'.repeat(50)+'!', verify buildFuzzyRegex completes in &lt;100ms</idea>
      <idea ac="AC1">Test timeout fallback: Mock slow regex, verify graceful degradation with null return</idea>
      <idea ac="AC2">Test length validation: Input strings &gt;10,000 chars should be chunked or rejected</idea>
      <idea ac="AC2">Test chunking behavior: Large documents split correctly without losing entities</idea>
      <idea ac="AC3">Test pattern efficiency: Compare old pattern `{0,3}` vs new `{0,2}?` with benchmark</idea>
      <idea ac="AC3">Test linear complexity: Verify O(n) not O(2^n) by measuring time ratios for increasing input sizes</idea>
      <idea ac="AC4">Add test vectors: 'a'.repeat(50), alternating patterns 'ababab...', mixed special chars 'a!a!a!'</idea>
      <idea ac="AC4">Regression test: Ensure future changes don't reintroduce exponential patterns</idea>
    </ideas>
  </tests>
</story-context>
