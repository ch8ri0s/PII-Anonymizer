<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>6</epicId>
    <storyId>3</storyId>
    <title>IPC Input Validation Layer</title>
    <status>drafted</status>
    <generatedAt>2025-12-15</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/stories/6-3-ipc-input-validation.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>security engineer</asA>
    <iWant>all IPC handlers to validate their inputs</iWant>
    <soThat>malicious payloads from the renderer cannot cause security issues</soThat>
    <tasks>
      <task id="1" name="Create Validation Infrastructure" acs="5">
        <subtask id="1.1">Create src/utils/ipcValidator.ts</subtask>
        <subtask id="1.2">Add Zod dependency for schema validation</subtask>
        <subtask id="1.3">Define common validation schemas (paths, options, etc.)</subtask>
      </task>
      <task id="2" name="Implement Type Validators" acs="1">
        <subtask id="2.1">Create string validator with length limits</subtask>
        <subtask id="2.2">Create object validator with required fields</subtask>
        <subtask id="2.3">Create array validator with item limits</subtask>
        <subtask id="2.4">Add error message formatting</subtask>
      </task>
      <task id="3" name="Implement Path Validation" acs="2">
        <subtask id="3.1">Create path traversal detector</subtask>
        <subtask id="3.2">Add path normalization before validation</subtask>
        <subtask id="3.3">Create allowlist/blocklist support</subtask>
        <subtask id="3.4">Log blocked path attempts</subtask>
      </task>
      <task id="4" name="Implement Size Limits" acs="3">
        <subtask id="4.1">Add file size validation before processing</subtask>
        <subtask id="4.2">Add request payload size limits</subtask>
        <subtask id="4.3">Make limits configurable via settings</subtask>
      </task>
      <task id="5" name="Implement Sender Verification" acs="4">
        <subtask id="5.1">Create sender verification helper</subtask>
        <subtask id="5.2">Add to all sensitive IPC handlers</subtask>
        <subtask id="5.3">Log verification failures</subtask>
      </task>
      <task id="6" name="Migrate IPC Handlers" acs="1,2,3,4,5">
        <subtask id="6.1">Update process-file handler in main.js</subtask>
        <subtask id="6.2">Update file preview handlers</subtask>
        <subtask id="6.3">Update feedback handlers</subtask>
        <subtask id="6.4">Update i18n handlers</subtask>
        <subtask id="6.5">Update all other handlers</subtask>
      </task>
      <task id="7" name="Testing" acs="1,2,3,4,5">
        <subtask id="7.1">Add unit tests for validators</subtask>
        <subtask id="7.2">Add integration tests for IPC security</subtask>
        <subtask id="7.3">Add malicious payload test vectors</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1" title="Type Validation">
      <requirement>All IPC inputs are validated for correct types</requirement>
      <requirement>Required fields are checked for presence</requirement>
      <requirement>Invalid inputs return structured error responses</requirement>
    </criterion>
    <criterion id="AC2" title="Path Safety">
      <requirement>File paths are validated against traversal patterns</requirement>
      <requirement>Paths are normalized and resolved safely</requirement>
      <requirement>Blocked paths are logged with sanitized details</requirement>
    </criterion>
    <criterion id="AC3" title="Size Limits">
      <requirement>File size limits are enforced (default: 100MB)</requirement>
      <requirement>Request payload sizes are limited</requirement>
      <requirement>OOM attacks are prevented</requirement>
    </criterion>
    <criterion id="AC4" title="Sender Verification">
      <requirement>Sender origin is verified against main window</requirement>
      <requirement>Unauthorized senders are rejected</requirement>
      <requirement>Verification failures are logged</requirement>
    </criterion>
    <criterion id="AC5" title="Reusable Validation">
      <requirement>Validation helpers are centralized and reusable</requirement>
      <requirement>Schema validation library (Zod or similar) is used</requirement>
      <requirement>Validation errors include helpful messages</requirement>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/CODE_REVIEW.md</path>
        <title>Comprehensive Code Review</title>
        <section>High Priority Issue #10, #15</section>
        <snippet>IPC handlers lack input validation. All ipcMain.handle calls should validate input types, required fields, path safety, and size limits. Sender verification is also missing (CSRF risk).</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Story 6.3: IPC Input Validation Layer</section>
        <snippet>Create src/utils/ipcValidator.ts with reusable validation helpers. Add Zod schema validation. Implement sender verification using BrowserWindow.fromWebContents(event.sender).</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>System Architecture</title>
        <section>IPC Security</section>
        <snippet>Electron uses IPC to communicate between main and renderer processes. All IPC handlers must validate inputs to prevent injection attacks.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>src/main.ts</path>
        <kind>ipc-handlers</kind>
        <symbol>ipcMain.handle('process-file')</symbol>
        <lines>208-288</lines>
        <reason>PRIMARY TARGET: Existing handler has PARTIAL validation (type check, file exists, size limit, extension) but lacks Zod schema, sender verification, and centralized pattern</reason>
      </artifact>
      <artifact>
        <path>src/main.ts</path>
        <kind>ipc-handlers</kind>
        <symbol>ipcMain.handle('file:readJson')</symbol>
        <lines>293-347</lines>
        <reason>Handler with basic string validation - needs Zod schema and sender verification</reason>
      </artifact>
      <artifact>
        <path>src/main.ts</path>
        <kind>ipc-handlers</kind>
        <symbol>ipcMain.handle('open-folder')</symbol>
        <lines>348-370</lines>
        <reason>Handler accepting folder path - needs path safety validation</reason>
      </artifact>
      <artifact>
        <path>src/services/filePreviewHandlers.ts</path>
        <kind>ipc-handlers</kind>
        <symbol>registerFilePreviewHandlers</symbol>
        <lines>33-120</lines>
        <reason>File preview handlers (getMetadata, getPreview, selectFiles) - need validation migration</reason>
      </artifact>
      <artifact>
        <path>src/services/feedbackHandlers.ts</path>
        <kind>ipc-handlers</kind>
        <symbol>registerFeedbackHandlers</symbol>
        <lines>85-122</lines>
        <reason>GOOD EXAMPLE: feedbackHandlers has validateCorrectionInput() pattern to follow</reason>
      </artifact>
      <artifact>
        <path>src/services/i18nHandlers.ts</path>
        <kind>ipc-handlers</kind>
        <symbol>registerI18nHandlers</symbol>
        <lines>56-93</lines>
        <reason>i18n handlers with locale string parameter - needs type validation</reason>
      </artifact>
      <artifact>
        <path>src/services/modelHandlers.ts</path>
        <kind>ipc-handlers</kind>
        <symbol>registerModelHandlers</symbol>
        <lines>33-90</lines>
        <reason>Model handlers (check, download, cleanup, getPaths) - mostly no-arg, low risk</reason>
      </artifact>
      <artifact>
        <path>src/services/accuracyHandlers.ts</path>
        <kind>ipc-handlers</kind>
        <symbol>registerAccuracyHandlers</symbol>
        <lines>55-80</lines>
        <reason>Accuracy handlers with options parameter - needs schema validation</reason>
      </artifact>
      <artifact>
        <path>src/utils/pathValidator.ts</path>
        <kind>utility</kind>
        <symbol>validateFilePath, PathValidationError</symbol>
        <lines>1-216</lines>
        <reason>EXISTING UTILITY: Path validation already implemented - integrate into IPC validator</reason>
      </artifact>
      <artifact>
        <path>src/utils/LoggerFactory.ts</path>
        <kind>utility</kind>
        <symbol>LoggerFactory</symbol>
        <lines>244-351</lines>
        <reason>From Story 6.1 - use LoggerFactory.create('ipcValidator') for logging</reason>
      </artifact>
      <artifact>
        <path>src/utils/safeRegex.ts</path>
        <kind>utility</kind>
        <symbol>SafeRegexConfig, SafeRegexResult</symbol>
        <lines>24-49</lines>
        <reason>From Story 6.2 - follow interface pattern for IpcValidationConfig and IpcValidationResult</reason>
      </artifact>
      <artifact>
        <path>test/unit/ipcValidation.test.js</path>
        <kind>test</kind>
        <symbol>IPC Validation Tests</symbol>
        <lines>1-100</lines>
        <reason>Existing tests for basic IPC validation - extend with comprehensive security tests</reason>
      </artifact>
    </code>
    <dependencies>
      <node>
        <package>electron</package>
        <version>39.1.1</version>
        <relevance>IpcMainInvokeEvent type, BrowserWindow for sender verification</relevance>
      </node>
      <potential-additions>
        <package>zod</package>
        <reason>Schema validation library for type-safe IPC input validation - AC5 requirement</reason>
        <version>^3.22.0</version>
      </potential-additions>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint source="CODE_REVIEW.md">All IPC handlers must validate inputs before processing</constraint>
    <constraint source="CODE_REVIEW.md">Sender verification required using BrowserWindow.fromWebContents(event.sender)</constraint>
    <constraint source="SECURITY">No user input should reach fs operations without validation</constraint>
    <constraint source="Electron">contextIsolation: true means renderer cannot directly access Node APIs</constraint>
    <constraint source="Performance">Validation overhead should be minimal (&lt;1ms per call)</constraint>
    <constraint source="Backward Compatibility">Existing IPC channel names and response formats must be preserved</constraint>
    <constraint source="pathValidator.ts">Existing path validation logic should be reused, not duplicated</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>validateIpcInput</name>
      <kind>function</kind>
      <signature>function validateIpcInput(data: unknown, schema: Record&lt;string, string&gt;): { valid: boolean; error?: string }</signature>
      <path>src/main.ts:211</path>
    </interface>
    <interface>
      <name>validateCorrectionInput</name>
      <kind>function</kind>
      <signature>function validateCorrectionInput(input: unknown): input is CorrectionEntry</signature>
      <path>src/services/feedbackHandlers.ts</path>
    </interface>
    <interface>
      <name>validateFilePath</name>
      <kind>function</kind>
      <signature>function validateFilePath(filePath: string, options?: PathValidationOptions): string</signature>
      <path>src/utils/pathValidator.ts:75</path>
    </interface>
    <interface>
      <name>PathValidationError</name>
      <kind>class</kind>
      <signature>class PathValidationError extends Error { code: FileErrorCode }</signature>
      <path>src/utils/pathValidator.ts:39</path>
    </interface>
    <interface>
      <name>LoggerFactory.create</name>
      <kind>static-method</kind>
      <signature>static create(scope: string): Logger</signature>
      <path>src/utils/LoggerFactory.ts:332</path>
    </interface>
    <interface>
      <name>BrowserWindow.fromWebContents</name>
      <kind>static-method</kind>
      <signature>static fromWebContents(webContents: WebContents): BrowserWindow | null</signature>
      <path>electron</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Testing uses Mocha + Chai framework with 10-second default timeout. Security tests should use shorter timeouts (2-5 seconds). Test files go in test/unit/ with .test.js extension. Follow the 50-test pattern established in safeRegex.test.js for comprehensive security coverage including attack vectors, edge cases, and configuration tests.
    </standards>
    <locations>
      <location>test/unit/ipcValidation.test.js</location>
      <location>test/unit/</location>
    </locations>
    <ideas>
      <idea ac="AC1">Test type validation: string inputs, object inputs, array inputs, null/undefined handling</idea>
      <idea ac="AC1">Test required field detection: missing fields, empty strings, whitespace-only strings</idea>
      <idea ac="AC2">Test path traversal: ../../../etc/passwd, %2e%2e%2f encoded paths, null bytes in paths</idea>
      <idea ac="AC2">Test path normalization: resolve symlinks, handle Unicode normalization attacks</idea>
      <idea ac="AC3">Test size limits: files at exactly limit, 1 byte over, very large sizes (prevent integer overflow)</idea>
      <idea ac="AC3">Test payload limits: large JSON objects, deeply nested objects, array bomb attacks</idea>
      <idea ac="AC4">Test sender verification: null sender, sender from different window, devtools sender</idea>
      <idea ac="AC5">Test Zod schema validation: custom error messages, nested object validation, union types</idea>
      <idea ac="AC5">Test validation helper reusability: same validator used across multiple handlers</idea>
    </ideas>
  </tests>
</story-context>
